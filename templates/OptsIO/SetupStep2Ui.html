<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    {% load static %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@7.2.96/css/materialdesignicons.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .setup-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }
        .setup-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .setup-header h1 {
            color: #667eea;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .setup-header p {
            color: #6c757d;
            font-size: 14px;
        }
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #6c757d;
            margin: 0 10px;
        }
        .step.active {
            background: #667eea;
            color: white;
        }
        .step.completed {
            background: #28a745;
            color: white;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: #667eea;
            border: none;
            padding: 12px 30px;
            font-weight: 500;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .alert {
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .section-title {
            color: #667eea;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }
        .db-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .db-summary .item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .db-summary .label {
            color: #6c757d;
            font-size: 14px;
        }
        .db-summary .value {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <h1><i class="mdi mdi-account-key"></i> {{ page_title }}</h1>
            <p>Configure el usuario administrador y opciones adicionales</p>
        </div>

        <div class="step-indicator">
            <div class="step completed">1</div>
            <div class="step active">2</div>
            <div class="step">3</div>
            <div class="step">4</div>
        </div>

        <div id="message-container"></div>

        <!-- Resumen de configuración de BD -->
        <div class="db-summary">
            <h6 class="mb-3"><i class="mdi mdi-database"></i> Configuración de Base de Datos</h6>
            <div class="item">
                <span class="label">Host:</span>
                <span class="value">{{ db_config.DB_HOST }}</span>
            </div>
            <div class="item">
                <span class="label">Puerto:</span>
                <span class="value">{{ db_config.DB_PORT }}</span>
            </div>
            <div class="item">
                <span class="label">Base de Datos:</span>
                <span class="value">{{ db_config.DB_NAME }}</span>
            </div>
            <div class="item">
                <span class="label">Usuario:</span>
                <span class="value">{{ db_config.DB_USER }}</span>
            </div>
        </div>

        <form id="form_setup_step2" action="{% url 'setup_step2' %}">
            <!-- Campos ocultos con config de BD -->
            <input type="hidden" name="db_host" value="{{ db_config.DB_HOST }}">
            <input type="hidden" name="db_port" value="{{ db_config.DB_PORT }}">
            <input type="hidden" name="db_name" value="{{ db_config.DB_NAME }}">
            <input type="hidden" name="db_user" value="{{ db_config.DB_USER }}">
            <input type="hidden" name="db_password" value="{{ db_config.DB_PASSWORD }}">

            <!-- Usuario Administrador -->
            <h5 class="section-title"><i class="mdi mdi-account-circle"></i> Usuario Administrador</h5>

            <div class="mb-3">
                <label for="admin_username" class="form-label">Nombre de Usuario</label>
                <input type="text" class="form-control" id="admin_username" name="admin_username"
                       value="admin" required>
            </div>

            <div class="mb-3">
                <label for="admin_email" class="form-label">Email</label>
                <input type="email" class="form-control" id="admin_email" name="admin_email"
                       value="admin@amachine.com" required>
            </div>

            <div class="mb-3">
                <label for="admin_password" class="form-label">Contraseña</label>
                <input type="password" class="form-control" id="admin_password" name="admin_password"
                       value="admin123" required>
                <small class="text-muted">Puede cambiar esta contraseña después del login</small>
            </div>

            <!-- Configuración Adicional -->
            <h5 class="section-title mt-4"><i class="mdi mdi-cog"></i> Configuración Adicional</h5>

            <div class="row">
                <div class="col-md-8 mb-3">
                    <label for="redis_host" class="form-label">Redis Host</label>
                    <input type="text" class="form-control" id="redis_host" name="redis_host"
                           value="127.0.0.1">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="redis_port" class="form-label">Puerto</label>
                    <input type="text" class="form-control" id="redis_port" name="redis_port"
                           value="6379">
                </div>
            </div>

            <div class="mb-3">
                <label for="fdomain" class="form-label">Dominio de la Aplicación</label>
                <input type="url" class="form-control" id="fdomain" name="fdomain"
                       value="http://localhost:8000">
                <small class="text-muted">URL base donde se accederá a la aplicación</small>
            </div>

            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary">
                    Crear Configuración <i class="mdi mdi-arrow-right"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Modal de Reinicio Requerido -->
    <div class="modal fade" id="restartModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="mdi mdi-restart-alert"></i> Reinicio Requerido
                    </h5>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="mdi mdi-file-check-outline text-success" style="font-size: 64px;"></i>
                        <h4 class="mt-3">Archivo .env creado exitosamente</h4>
                    </div>

                    <div class="alert alert-warning">
                        <strong>Importante:</strong> Debes reiniciar el servidor Django para que tome la nueva configuración.
                    </div>

                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="mdi mdi-laptop"></i> En Desarrollo
                        </div>
                        <div class="card-body">
                            <ol class="mb-0">
                                <li>Detén el servidor con <kbd>Ctrl+C</kbd></li>
                                <li>Ejecuta: <code>python manage.py runserver</code></li>
                            </ol>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-light">
                            <i class="mdi mdi-docker"></i> En Docker
                        </div>
                        <div class="card-body">
                            <p class="mb-0">Ejecuta: <code>docker compose restart web</code></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <a href="{% url 'setup_finalize' %}" class="btn btn-primary btn-lg">
                        <i class="mdi mdi-arrow-right-circle"></i> Ya reinicié, continuar al Paso 3
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        function showMessage(message, type) {
            const container = document.getElementById('message-container');
            container.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }

        function showRestartModal() {
            const modal = new bootstrap.Modal(document.getElementById('restartModal'));
            modal.show();
        }

        // Enviar formulario
        document.getElementById('form_setup_step2').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const submitBtn = this.querySelector('button[type="submit"]');
            const formUrl = this.action;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

            try {
                const response = await axios.post(formUrl, formData);

                if (response.data.success) {
                    if (response.data.needs_restart) {
                        // Mostrar modal de reinicio requerido
                        showRestartModal();
                    } else {
                        showMessage(response.data.message + ' Redirigiendo...', 'success');
                        setTimeout(() => {
                            window.location.href = response.data.next_step || '/setup/finalize/';
                        }, 1500);
                    }
                } else {
                    showMessage(response.data.message, 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Crear Configuración <i class="mdi mdi-arrow-right"></i>';
                }
            } catch (error) {
                const message = error.response?.data?.message || 'Error al procesar configuración';
                showMessage(message, 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Crear Configuración <i class="mdi mdi-arrow-right"></i>';
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
