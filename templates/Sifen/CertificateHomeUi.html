<div class="certificate_ui_container container-fluid">
    <div class="certificate_ui_msgs"></div>
    <!-- Toolbar -->
    <div class="toolbar mb-3 d-flex justify-content-between align-items-center">
        <div class="toolbar-buttons">
            <button id="btn_crear_certificate" class="btn btn-primary me-2">
                <i class="mdi mdi-plus"></i> Cargar Certificado
            </button>
            <button id="btn_borrar_certificate" class="btn btn-danger me-2">
                <i class="mdi mdi-delete"></i> Eliminar
            </button>
            <button id="btn_procesar_certificate" class="btn btn-warning">
                <i class="mdi mdi-cog-sync"></i> Reprocesar
            </button>
        </div>
        <div class="toolbar-search">
            <input type="text" id="input_buscar_certificate" class="form-control" placeholder="Buscar por nombre o empresa...">
        </div>
    </div>

    <div id="table_certificate_ui"></div>
</div>
<script type="text/javascript">
    var gmquery_cert = [];

    certificate_home_be = function (data, settings) {
        tt = qelem(`#table_certificate_ui`);
        tt.classList.add('overlay-container');
        tt.classList.add('overlay');
        crdata = Object.assign({}, settings.ajax.initquery);
        mquery = [];
        t_guid = settings.ajax.t_guid;
        if (gmquery_cert.length > 0) {
            log.info(`Adding global mquery: ${jfy(gmquery_cert)}`);
            mquery = [...mquery, ...gmquery_cert];
        }
        log.info(`certificate_home_be mquery: ${jfy(mquery)}`);
        if (mquery.length > 0) {
            crdata.mquery = jfy(mquery);
        }
        adata = Object.assign(data, crdata);
        return adata
    }

    // Helper para formatear el estado con badge
    certificate_estado_badge = (estado) => {
        const badges = {
            'pendiente': '<span class="badge bg-secondary">Pendiente</span>',
            'activo': '<span class="badge bg-success">Activo</span>',
            'vencido': '<span class="badge bg-danger">Vencido</span>',
            'error': '<span class="badge bg-warning text-dark">Error</span>',
            'revocado': '<span class="badge bg-dark">Revocado</span>'
        };
        return badges[estado] || `<span class="badge bg-secondary">${estado}</span>`;
    }

    // Helper para formatear fecha de vencimiento con alerta
    certificate_vencimiento_format = (fecha, estado) => {
        if (!fecha) return '-';
        const fechaObj = new Date(fecha);
        const hoy = new Date();
        const diasRestantes = Math.floor((fechaObj - hoy) / (1000 * 60 * 60 * 24));

        let formatted = fechaObj.toLocaleDateString('es-PY');

        if (estado === 'vencido') {
            return `<span class="text-danger fw-bold">${formatted}</span>`;
        } else if (diasRestantes <= 30 && diasRestantes > 0) {
            return `<span class="text-warning fw-bold">${formatted} <small>(${diasRestantes} dias)</small></span>`;
        } else if (diasRestantes <= 90 && diasRestantes > 30) {
            return `<span class="text-info">${formatted}</span>`;
        }
        return formatted;
    }

    t_certificate = `dtable_${OptsIO.s4generate()}`;
    dt_certificate_pc = Grid.datatables_wrapper({
          t_guid: t_certificate,
          url_exec: '{% url "iom" %}',
          title: 'Certificados Digitales',
          tselector: 'table_certificate_ui',
          app_name: 'Sifen',
          model_name: 'Certificate',
          cls_table: 'cell-border row-border table table-sm',
          cls_thead: 'border-gray-900',
          mquery: [],
          plength: 50,
          check_gmquery: true,
          builder_be: certificate_home_be,
          t_opts: {
              select: {
                style: 'os'
              },
              select: true,
              fixedHeader: true,
              responsive: null,
              scrollCollapse: true,
              scrollX: true,
              scrollY: 500,
              paging: true,
              order: [[1, 'desc']],
              rowId: function(row, se) {
                  return `tr_cert_${row.id}`
              }
          },
          columns: [
               { fdis: true, gre: false, btyp: 'loc', idx: null, tit: 'ACC',  dtyp: 'str', dfl: '', nord: false,
                dfcon: `
                    <i title="Ver/Editar" class="tr-certificate-query text fs-5 mdi mdi-eye"></i>
                `,
               },
               { fdis: true,
                 gre: true,
                 btyp: 'fdb',
                 idx: 'nombre',
                 tit: 'Nombre',
                 cls: 'align-left',
                 dtyp: 'str',
                 hide: false
              },
              { fdis: true,
                 gre: true,
                 btyp: 'fdb',
                 idx: 'businessobj__name',
                 tit: 'Empresa',
                 cls: 'align-left',
                 dtyp: 'str',
                 hide: false
              },
              { fdis: true,
                 gre: true,
                 btyp: 'fdb',
                 idx: 'titular',
                 tit: 'Titular',
                 cls: 'align-left',
                 dtyp: 'str',
                 hide: false
              },
              { fdis: true,
                 gre: true,
                 btyp: 'loc',
                 idx: 'estado',
                 tit: 'Estado',
                 cls: 'align-center',
                 dtyp: 'str',
                 hide: false,
                 render: function(data, type, row) {
                    return certificate_estado_badge(data);
                 }
              },
              { fdis: true,
                 gre: true,
                 btyp: 'loc',
                 idx: 'es_predeterminado',
                 tit: 'Predeterminado',
                 cls: 'align-center',
                 dtyp: 'str',
                 hide: false,
                 render: function(data, type, row) {
                    return data ? '<i class="mdi mdi-check-circle text-success fs-5"></i>' : '';
                 }
              },
              { fdis: true,
                 gre: true,
                 btyp: 'fdb',
                 idx: 'emisor',
                 tit: 'Emisor',
                 cls: 'align-left',
                 dtyp: 'str',
                 hide: false
              },
              { fdis: true,
                 gre: true,
                 btyp: 'loc',
                 idx: 'fecha_vencimiento',
                 tit: 'Vencimiento',
                 cls: 'align-center',
                 dtyp: 'str',
                 hide: false,
                 render: function(data, type, row) {
                    return certificate_vencimiento_format(data, row.estado);
                 }
              },
              { fdis: true,
                 gre: true,
                 btyp: 'fdb',
                 idx: 'documentos_firmados',
                 tit: 'Docs. Firmados',
                 cls: 'align-right',
                 dtyp: 'int',
                 hide: false
              },
              { fdis: true,
                 gre: true,
                 btyp: 'fdb',
                 idx: 'cargado_fecha',
                 tit: 'Fecha Carga',
                 cls: 'align-center',
                 dtyp: 'date',
                 hide: false
              },
          ]
      })

    $(`#${t_certificate} tbody`).on('click', '.tr-certificate-query', function() {
        let elerow = $(this).closest('tr');
        let rowobj = $(`#${t_certificate}`).DataTable().row( elerow ).data()
        certificate_form_crud(rowobj.id);
    })

    qelem('#btn_crear_certificate').addEventListener('click', function() {
          certificate_form_crud();
      });

    qelem('#btn_borrar_certificate').addEventListener('click', function() {
        let table = $(`#${t_certificate}`).DataTable();
        let selectedRows = table.rows({ selected: true });
        if (selectedRows.count() === 0) {
            UiB.MsgError('Por favor, selecciona al menos un certificado para eliminar.');
            return;
        }
        let idsToDelete = selectedRows.data().toArray().map(row => row.id);
        UiB.MsgSwall({
            msg: `¿Estás seguro de que deseas eliminar ${idsToDelete.length} certificado(s)? Esta accion no se puede deshacer.`,
            ttype: 'warning'
        }).then((result) => {
            let gbe = new FormData();
            gbe.append('module', 'Sifen');
            gbe.append('package', 'mng_certificate');
            gbe.append('attr', 'MCertificate');
            gbe.append('mname', 'delete_certificates');
            gbe.append('dbcon', 'default');
            gbe.append('ids', jfy(idsToDelete));
            axios.post('{% url "iom" %}', gbe).then((rsp)=>{
                msgs = rsp.data.msgs;
                log.info(`Mensaje recibido del backend: ${jfy(msgs)}`);
                UiB.BeMsgHandle({
                    rsps: msgs,
                    timer: 2000,
                    offcanvasglobal: true
                })
                $(`#${t_certificate}`).DataTable().ajax.reload();
            }).catch((err)=>{
                log.error(`Error al eliminar certificados: ${jfy(err)}`);
                UiB.MsgError('Ocurrio un error al eliminar los certificados. Por favor, intenta de nuevo.');
            });
        });
    });

    qelem('#btn_procesar_certificate').addEventListener('click', function() {
        let table = $(`#${t_certificate}`).DataTable();
        let selectedRows = table.rows({ selected: true });
        if (selectedRows.count() === 0) {
            UiB.MsgError('Por favor, selecciona al menos un certificado para reprocesar.');
            return;
        }
        let idsToProcess = selectedRows.data().toArray().map(row => row.id);
        UiB.MsgSwall({
            msg: `¿Deseas reprocesar ${idsToProcess.length} certificado(s)? Esto regenerara los archivos PEM y KEY.`,
            ttype: 'info'
        }).then((result) => {
            let gbe = new FormData();
            gbe.append('module', 'Sifen');
            gbe.append('package', 'mng_certificate');
            gbe.append('attr', 'MCertificate');
            gbe.append('mname', 'reprocess_certificates');
            gbe.append('dbcon', 'default');
            gbe.append('ids', jfy(idsToProcess));
            axios.post('{% url "iom" %}', gbe).then((rsp)=>{
                msgs = rsp.data.msgs;
                log.info(`Mensaje recibido del backend: ${jfy(msgs)}`);
                UiB.BeMsgHandle({
                    rsps: msgs,
                    timer: 3000,
                    offcanvasglobal: true
                })
                $(`#${t_certificate}`).DataTable().ajax.reload();
            }).catch((err)=>{
                log.error(`Error al reprocesar certificados: ${jfy(err)}`);
                UiB.MsgError('Ocurrio un error al reprocesar los certificados.');
            });
        });
    });

    certificate_form_crud = (pk) => {
        dattrs = {
            title: 'Cargar Certificado',
            t_guid: t_certificate,
            sui_rr: '{{ rr }}',
            from_CertificateUi: true,
            offcanvasglobal: true
        }

        tps = {
            model_app_name: 'Sifen',
            model_name: 'Certificate',
            dbcon: 'default',
            url: '{% url "dtmpl" %}',
            dattrs: dattrs,
            template: 'Sifen/CertificateCreateUi.html',
            raw: true,

        }
        if (pk) {
            tps['pk'] = pk;
            dattrs['title'] = 'Editar Certificado';
        }
        OptsIO.getTmpl(tps).then((rsp)=>{
            let data = rsp.data;
            $('#offcanvasGlobalUiBody').html(data);
            let bsOffcanvas = new bootstrap.Offcanvas('#offcanvasGlobalUi')
            bsOffcanvas.show();
            let tmpOffcanvas = document.getElementById('offcanvasGlobalUi')
            tmpOffcanvas.addEventListener('hidden.bs.offcanvas', event => {
                $('#offcanvasGlobalUiBody').html('');
            })
            UiB.kILLLoaderAjax();
        })
    }

    qelem('#input_buscar_certificate').onkeydown = (evt) => {
        if (evt.key === 'Enter') {
            gmquery_cert = [];
            if (qelem('#input_buscar_certificate').value.trim() !== '') {
                gmquery_cert.push({
                    'field': 'or_nombre__icontains', 'value': qelem('input#input_buscar_certificate').value
                })
                gmquery_cert.push({
                    'field': 'or_businessobj__name__icontains', 'value': qelem('input#input_buscar_certificate').value
                })
                gmquery_cert.push({
                    'field': 'or_titular__icontains', 'value': qelem('input#input_buscar_certificate').value
                })
            }
            $(`#${t_certificate}`).DataTable().ajax.reload();
        }
    }

$(`#${t_certificate}`).on('draw.dt', function() {
  tt = qelem(`#table_certificate_ui`);
  tt.classList.remove('overlay-container');
  tt.classList.remove('overlay');
})

</script>
