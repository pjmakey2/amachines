<div class="ui_documentnc">
    <form id="form_documentnc_{{ rr }}" class="form_documentnc">
        {% if mobj %}
            <input type="hidden"
                name="id"
                value="{{ mobj.pk }}"
            >
        {% endif %}
        <input type='hidden' name="source" value="MANUAL" />
        <input type='hidden' name="doc_tipo" value="NC" />
        <input type='hidden' name="doc_op" value="NC" />
        <input type='hidden' name="doc_tipo_cod" value="2" />
        <input type='hidden' name="pdv_es_contribuyente" value="true" />

        <!-- Row 1: RUC Cliente -->
        <div class="row mt-2">
            <div class="msg_pdv_ruc"></div>
            <div class="col-md-2">
                <div class="form-floating form-floating-sm">
                    <input
                        required
                        type="text"
                        name="pdv_ruc"
                        class="form-control"
                        placeholder="RUC"
                        oninput="form_validation.just_number(event)"
                        {% if mobj %} value="{{ mobj.pdv_ruc }}" {% endif %}
                    />
                    <label>RUC</label>
                </div>
            </div>
            <div class="col-md-1">
                <div class="form-floating form-floating-sm">
                    <input
                        type="number"
                        name="pdv_ruc_dv"
                        class="form-control bg-light"
                        placeholder="DV"
                        readonly
                        {% if mobj %} value="{{ mobj.pdv_ruc_dv }}" {% endif %}
                    />
                    <label>DV</label>
                </div>
            </div>
            <div class="col-md-5">
                <div class="form-floating form-floating-sm">
                    <input
                        required
                        type="text"
                        name="pdv_nombrefactura"
                        class="form-control bg-light"
                        placeholder="Nombre Factura"
                        readonly
                        {% if mobj %} value="{{ mobj.pdv_nombrefactura }}" {% endif %}
                    />
                    <label>Nombre Factura</label>
                </div>
            </div>
        </div>

        <!-- Row 2: Factura Relacionada y Motivo -->
        <div class="row mt-2">
            <div class="col-md-4">
                <div class="form-floating form-floating-sm">
                    <select
                        required
                        name="doc_relacion_cdc"
                        class="form-select"
                        disabled
                    >
                        <option value="">Ingrese RUC primero</option>
                    </select>
                    <label>Factura Relacionada</label>
                </div>
                <small class="msg_facturas text-muted"></small>
            </div>
            <div class="col-md-3">
                <div class="form-floating form-floating-sm">
                    <select required name="doc_motivo" class="form-select">
                        <option value="">Seleccione</option>
                        <option value="Devolución" {% if mobj and mobj.doc_motivo == 'Devolución' %}selected{% endif %}>Devolución</option>
                        <option value="Bonificación" {% if mobj and mobj.doc_motivo == 'Bonificación' %}selected{% endif %}>Bonificación</option>
                        <option value="Crédito incobrable" {% if mobj and mobj.doc_motivo == 'Crédito incobrable' %}selected{% endif %}>Crédito incobrable</option>
                    </select>
                    <label>Motivo</label>
                </div>
            </div>
        </div>

        <!-- Row 3: pdv_celular, pdv_email (READONLY) -->
        <div class="row mt-2 d-none">
            <div class="col-md-2">
                <div class="form-floating form-floating-sm">
                    <input
                        type="text"
                        name="pdv_celular"
                        class="form-control bg-light"
                        placeholder="Celular"
                        readonly
                        value="{% if mobj %}{{ mobj.pdv_celular }}{% else %}000000{% endif %}"
                    />
                    <label>Celular</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-floating form-floating-sm">
                    <input
                        type="email"
                        name="pdv_email"
                        class="form-control bg-light"
                        placeholder="Email"
                        readonly
                        {% if mobj %} value="{{ mobj.pdv_email }}" {% endif %}
                    />
                    <label>Email</label>
                </div>
            </div>
        </div>


        <!-- Row 5: doc_moneda, doc_cre_tipo_cod -->
        <div class="row mt-2">
            <div class="col-md-2">
                <div class="form-floating form-floating-sm">
                    <select disabled readonly required name="doc_moneda" class="form-select">
                        <option></option>
                        <option value="GS" {% if mobj.doc_moneda == 'GS' %}selected{% endif %}>GS - Guaraníes</option>
                        <option value="USD" {% if mobj.doc_moneda == 'USD' %}selected{% endif %}>USD - Dólares</option>
                    </select>
                    <label>Moneda</label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-floating form-floating-sm">
                    <select
                        required disabled
                        name="doc_cre_tipo_cod"
                        class="form-select"
                    >
                        <option {% if not mobj %} selected {% endif %} {% if mobj.doc_cre_tipo_cod == 1 %}selected{% endif %} value="1">Contado</option>
                        <option selected value="2">Crédito</option>
                    </select>
                    <label>Cond. Venta</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-floating form-floating-sm">
                    <select disabled required name="pdv_type_business" class="form-select">
                        <option value="B2C" {% if not mobj or mobj.pdv_type_business == 'B2C' %}selected{% endif %}>B2C - Consumidor</option>
                        <option value="B2B" {% if mobj.pdv_type_business == 'B2B' %}selected{% endif %}>B2B - Empresa</option>
                        <option value="B2G" {% if mobj.pdv_type_business == 'B2G' %}selected{% endif %}>B2G - Gobierno</option>
                        <option value="B2F" {% if mobj.pdv_type_business == 'B2F' %}selected{% endif %}>B2F - Extranjero</option>
                    </select>
                    <label>Tipo Negocio</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-floating form-floating-sm">
                    <select disabled required name="doc_tipo_pago_cod" class="form-select">
                        <option value="1" {% if not mobj.doc_tipo_pago_cod or mobj.doc_tipo_pago_cod == 1 %}selected{% endif %}>Efectivo</option>
                        <option value="2" {% if mobj.doc_tipo_pago_cod == 2 %}selected{% endif %}>Cheque</option>
                        <option value="3" {% if mobj.doc_tipo_pago_cod == 3 %}selected{% endif %}>Tarjeta crédito</option>
                        <option value="4" {% if mobj.doc_tipo_pago_cod == 4 %}selected{% endif %}>Tarjeta débito</option>
                        <option value="5" {% if mobj.doc_tipo_pago_cod == 5 %}selected{% endif %}>Transferencia</option>
                        <option value="6" {% if mobj.doc_tipo_pago_cod == 6 %}selected{% endif %}>Giro</option>
                        <option value="7" {% if mobj.doc_tipo_pago_cod == 7 %}selected{% endif %}>Billetera electrónica</option>
                        <option value="8" {% if mobj.doc_tipo_pago_cod == 8 %}selected{% endif %}>Tarjeta empresarial</option>
                        <option value="9" {% if mobj.doc_tipo_pago_cod == 9 %}selected{% endif %}>Vale</option>
                        <option value="10" {% if mobj.doc_tipo_pago_cod == 10 %}selected{% endif %}>Retención</option>
                        <option value="11" {% if mobj.doc_tipo_pago_cod == 11 %}selected{% endif %}>Pago anticipo</option>
                        <option value="12" {% if mobj.doc_tipo_pago_cod == 12 %}selected{% endif %}>Valor fiscal</option>
                        <option value="13" {% if mobj.doc_tipo_pago_cod == 13 %}selected{% endif %}>Valor comercial</option>
                        <option value="14" {% if mobj.doc_tipo_pago_cod == 14 %}selected{% endif %}>Compensación</option>
                        <option value="15" {% if mobj.doc_tipo_pago_cod == 15 %}selected{% endif %}>Permuta</option>
                        <option value="16" {% if mobj.doc_tipo_pago_cod == 16 %}selected{% endif %}>Pago bancario</option>
                        <option value="17" {% if mobj.doc_tipo_pago_cod == 17 %}selected{% endif %}>Pago Móvil</option>
                        <option value="18" {% if mobj.doc_tipo_pago_cod == 18 %}selected{% endif %}>Donación</option>
                        <option value="19" {% if mobj.doc_tipo_pago_cod == 19 %}selected{% endif %}>Promoción</option>
                        <option value="20" {% if mobj.doc_tipo_pago_cod == 20 %}selected{% endif %}>Consumo Interno</option>
                        <option value="21" {% if mobj.doc_tipo_pago_cod == 21 %}selected{% endif %}>Pago Electrónico</option>
                        <option value="99" {% if mobj.doc_tipo_pago_cod == 99 %}selected{% endif %}>Otro</option>
                    </select>
                    <label>Tipo Pago</label>
                </div>
            </div>
        </div>

        <!-- Row 4: timbrado_id, doc_establecimiento -->
        <div class="row mt-2">
            <div class="col-md-2">
                <div class="form-floating-select2 form-floating-select2-sm">
                    <select required name="timbrado_id" class="form-select"></select>
                    <label>Timbrado</label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-floating-select2 form-floating-select2-sm">
                    <select required name="doc_establecimiento" class="form-select"></select>
                    <label>Establecimiento</label>
                </div>
            </div>
            <div class="col-md-2">
                <div class="form-floating form-floating-sm">
                    <input type="text" name="doc_numero" class="form-control bg-light" readonly value="-" placeholder="Número" />
                    <label>Número</label>
                </div>
            </div>
        </div>

        <hr class="my-2">

        <!-- Detail Lines Section -->
        <h5 class="mb-3 d-none">Líneas de Detalle</h5>

        <div class="d-flex gap-1 align-items-end detail-input-section">
            <div>
                <label class="form-label mb-1">Unidad</label>
                <select
                    name="detail_prod_unidad_medida_desc"
                    class="form-select"
                    style="width: 120px;"
                >
                </select>
            </div>
            <div>
                <label class="form-label mb-1">Descripción</label>
                <select
                    name="detail_prod_descripcion"
                    class="form-select"
                    style="width: 300px;"
                >
                </select>
            </div>
            <div>
                <label class="form-label mb-1">PU</label>
                <input
                    type="text"
                    name="detail_precio_unitario"
                    class="form-control"
                    placeholder="0"
                    style="width: 180px;"
                />
            </div>
            <div>
                <label class="form-label mb-1">Cantidad</label>
                <input
                    type="text"
                    name="detail_cantidad"
                    class="form-control"
                    placeholder="0"
                    style="width: 90px;"
                />
            </div>
            <div>
                <button
                    type="button"
                    class="btn btn-success btn-sm btn_agregar_linea"
                >
                    <i class="mdi mdi-plus"></i>
                </button>
            </div>
        </div>

        <!-- Tax Distribution (only for manual products) -->
        <div class="row mt-2 div_tax_distribution" style="display:none;">
            <div class="col-md-12 mb-2">
                <small class="text-info"><strong>Distribución de Impuestos:</strong> La suma debe ser 100%. Solo se puede usar Gravada 5% + Exenta O Gravada 10% + Exenta.</small>
            </div>
            <div class="col-md-4">
                <div class="form-floating">
                    <input
                        type="text"
                        name="detail_exenta"
                        class="form-control"
                        placeholder="0"
                        value="0"
                    />
                    <label>Exenta (%)</label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-floating">
                    <input
                        type="text"
                        name="detail_g5"
                        class="form-control"
                        placeholder="0"
                        value="0"
                    />
                    <label>Gravada 5% (%)</label>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-floating">
                    <input
                        type="text"
                        name="detail_g10"
                        class="form-control"
                        placeholder="100"
                        value="100"
                    />
                    <label>Gravada 10% (%)</label>
                </div>
            </div>
        </div>

        <!-- Details Table -->
        <div class="row mt-4">
            <div class="col-md-12">
                <table class="table table-striped table-bordered table_details">
                    <thead class="table-dark thead_details">
                        <!-- Header will be rendered dynamically -->
                    </thead>
                    <tbody class="tbody_details">
                        <!-- Detail lines will be added here -->
                    </tbody>
                    <tfoot class="tfoot_details">
                        <!-- Footer will be rendered dynamically -->
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Submit Button -->
        <div class="row mt-4">
            <div class="col-md-2 text-start">
                <button
                    id="btn_crear"
                    class="btn btn-lg btn-primary"
                    type="submit"
                >
                    {% if mobj %} Actualizar {% else %} Guardar {% endif %}
                </button>
            </div>
            <div class="col-md-4 text-start">
                <button
                    id="btn_enviar"
                    class="btn btn-lg btn-info"
                    type="submit"
                >
                    {% if mobj %} Actualizar {% else %} Guardar {% endif %} y Enviar
                </button>
            </div>
        </div>

    </form>
</div>
<script type="text/javascript">
    qelem('#offcanvasGlobalUiLabel').innerHTML = `{% if mobj %}Modificar Nota de Crédito {{ mobj.pk }}{% else %}Crear Nota de Crédito{% endif %}`;

    // Array to store details
    var details = [];
    var editingIndex = null;
    var detailsReadonly = false;
    var facturaSaldoDisponible = 0;

    // Function to get current currency and decimal settings
    function getDecimalPlaces() {
        let moneda = qelem('select[name="doc_moneda"]').value;
        return moneda === 'USD' ? 2 : 0;
    }

    // Function to format number as money based on currency
    function formatMoney(value, decimals = null) {
        if (decimals === null) {
            decimals = getDecimalPlaces();
        }
        let num = parseFloat(value) || 0;
        return num.toLocaleString('es-PY', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    // Initialize input masks for money fields
    function initializeInputMasks() {
        let decimals = getDecimalPlaces();
        let maskOptions = {
            alias: 'numeric',
            groupSeparator: '.',
            radixPoint: ',',
            autoGroup: true,
            digits: decimals,
            digitsOptional: false,
            rightAlign: true,
            allowMinus: false,
            removeMaskOnSubmit: true,
            autoUnmask: true
        };

        // Apply mask to precio_unitario
        Inputmask(maskOptions).mask(qelem('#form_documentnc_{{ rr }} input[name=detail_precio_unitario]'));

        // Apply mask to cantidad
        Inputmask({
            alias: 'numeric',
            groupSeparator: '.',
            radixPoint: ',',
            autoGroup: true,
            digits: decimals,
            digitsOptional: false,
            rightAlign: true,
            allowMinus: false,
            removeMaskOnSubmit: true,
            autoUnmask: true
        }).mask(qelem('#form_documentnc_{{ rr }} input[name=detail_cantidad]'));
    }

    // Update masks when currency changes
    qelem('select[name="doc_moneda"]').addEventListener('change', function() {
        initializeInputMasks();
        renderDetailsTable();
    });

    // Initialize masks on load
    initializeInputMasks();

    // Initialize select2 for producto description with tags
    form_search.se_populate({
        surl: '{% url "iom" %}',
        dele: '#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]',
        app_name: 'Sifen',
        model_name: 'Producto',
        field_display: ['descripcion'],
        field_id: ['prod_cod'],
        sterm: ['descripcion', 'prod_cod'],
        db_fields: ['prod_cod', 'descripcion', 'precio', 'exenta', 'g5', 'g10', 'medidaobj__medida_cod', 'medidaobj__medida'],
        dbcon: 'default',
        tags: true,
        dropdownParent: $('#offcanvasGlobalUi'),
        theme: 'bootstrap-5',
        placeholder: 'Seleccione o escriba descripción'
    });

    // Initialize input masks for tax distribution fields
    var percentMaskOptions = {
        alias: 'numeric',
        groupSeparator: ',',
        radixPoint: '.',
        autoGroup: true,
        digits: 2,
        digitsOptional: false,
        rightAlign: true,
        allowMinus: false,
        removeMaskOnSubmit: true,
        autoUnmask: true,
        min: 0,
        max: 100
    };
    Inputmask(percentMaskOptions).mask(qelem('#form_documentnc_{{ rr }} input[name=detail_exenta]'));
    Inputmask(percentMaskOptions).mask(qelem('#form_documentnc_{{ rr }} input[name=detail_g5]'));
    Inputmask(percentMaskOptions).mask(qelem('#form_documentnc_{{ rr }} input[name=detail_g10]'));

    // Variable to store selected product data
    var selectedProductData = null;

    // Listen for product selection
    $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]').on('select2:select', function(e) {
        var data = e.params.data;

        // Check if it's a real product from database (has custom data)
        if (data.element && data.element.dataset) {
            selectedProductData = {
                prod_cod: data.element.dataset.prod_cod || data.id,
                precio: parseFloat(data.element.dataset.precio || 0),
                exenta: parseFloat(data.element.dataset.exenta || 0),
                g5: parseFloat(data.element.dataset.g5 || 0),
                g10: parseFloat(data.element.dataset.g10 || 0),
                medida_cod: data.element.dataset.medida_cod || '77',
                medida: data.element.dataset.medida || 'UNI'
            };

            // Auto-fill precio if product has price
            if (selectedProductData.precio > 0) {
                qelem('#form_documentnc_{{ rr }} input[name=detail_precio_unitario]').value = selectedProductData.precio;
            }

            // Auto-select unidad medida if available (use code, not string)
            if (selectedProductData.medida_cod) {
                $('#form_documentnc_{{ rr }} select[name=detail_prod_unidad_medida_desc]').val(selectedProductData.medida_cod).trigger('change');
            }

            // Hide tax distribution fields (product from model has its own distribution)
            qelem('#form_documentnc_{{ rr }} .div_tax_distribution').style.display = 'none';

            log.info('Product selected from database: ' + JSON.stringify(selectedProductData, null, 2));
        } else {
            // Manual entry (tag created, not from database)
            selectedProductData = null;
            // Show tax distribution fields for manual products
            qelem('#form_documentnc_{{ rr }} .div_tax_distribution').style.display = 'flex';

            log.info('Manual product entry detected');
        }

        // Set focus to precio_unitario field
        qelem('#form_documentnc_{{ rr }} input[name=detail_precio_unitario]').focus();
    });

    // Also handle when field is cleared
    $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]').on('select2:clear', function() {
        selectedProductData = null;
        qelem('#form_documentnc_{{ rr }} .div_tax_distribution').style.display = 'flex';
    });

    // RUC input validation and invoice lookup
    var rucInput = qelem('#form_documentnc_{{ rr }} input[name=pdv_ruc]');
    var facturaSelect = qelem('#form_documentnc_{{ rr }} select[name=doc_relacion_cdc]');
    var msgRuc = qelem('#form_documentnc_{{ rr }} .msg_pdv_ruc');
    var msgFacturas = qelem('#form_documentnc_{{ rr }} .msg_facturas');

    rucInput.addEventListener('blur', function() {
        let ruc = this.value.trim();

        if (!ruc) {
            // Clear all fields
            qelem('#form_documentnc_{{ rr }} input[name=pdv_ruc_dv]').value = '';
            qelem('#form_documentnc_{{ rr }} input[name=pdv_nombrefactura]').value = '';
            qelem('#form_documentnc_{{ rr }} input[name=pdv_celular]').value = '';
            qelem('#form_documentnc_{{ rr }} input[name=pdv_email]').value = '';
            facturaSelect.disabled = true;
            facturaSelect.innerHTML = '<option value="">Ingrese RUC del cliente primero</option>';
            msgRuc.textContent = '';
            msgFacturas.textContent = '';
            return;
        }

        // Validate RUC and get client data
        let fdata = new FormData();
        fdata.append('module', 'Sifen');
        fdata.append('package', 'mng_sifen');
        fdata.append('attr', 'MSifen');
        fdata.append('mname', 'validate_ruc');
        fdata.append('ruc', ruc);

        axios.post('{% url "iom" %}', fdata, {
            headers: { 'X-CSRFToken': OptsIO.getCookie('csrftoken') }
        }).then((rsp) => {
            let rdata = rsp.data;

            if (rdata.success) {
                // Populate client fields
                qelem('#form_documentnc_{{ rr }} input[name=pdv_ruc_dv]').value = rdata.pdv_ruc_dv || '';
                qelem('#form_documentnc_{{ rr }} input[name=pdv_nombrefactura]').value = rdata.pdv_nombrefactura || '';
                qelem('#form_documentnc_{{ rr }} input[name=pdv_celular]').value = rdata.pdv_celular || '';
                qelem('#form_documentnc_{{ rr }} input[name=pdv_email]').value = rdata.pdv_email || '';
                if (rdata.pdv_type_business) {
                    qelem('#form_documentnc_{{ rr }} select[name=pdv_type_business]').value = rdata.pdv_type_business;
                }

                msgRuc.className = 'msg_pdv_ruc text-success';
                msgRuc.textContent = 'RUC válido';

                // Load invoices for this RUC
                loadInvoicesForRuc(ruc);
            } else {
                msgRuc.className = 'msg_pdv_ruc text-danger';
                msgRuc.textContent = rdata.error || 'RUC no válido';
                // Calculate DV locally if validation fails
                form_input.calculate_dv('#form_documentnc_{{ rr }} input[name=pdv_ruc]', '#form_documentnc_{{ rr }} input[name=pdv_ruc_dv]');
                facturaSelect.disabled = true;
                facturaSelect.innerHTML = '<option value="">RUC no válido</option>';
                msgFacturas.textContent = '';
            }
        }).catch((err) => {
            log.error('Error validating RUC: ' + JSON.stringify(err, null, 2));
            msgRuc.className = 'msg_pdv_ruc text-danger';
            msgRuc.textContent = 'Error al validar RUC';
        });
    });

    // Function to load invoices for a given RUC
    function loadInvoicesForRuc(ruc) {
        let fdata = new FormData();
        fdata.append('module', 'OptsIO');
        fdata.append('package', 'io_serial');
        fdata.append('attr', 'IoS');
        fdata.append('mname', 'seModel');
        fdata.append('model_app_name', 'Sifen');
        fdata.append('model_name', 'DocumentHeader');
        fdata.append('dbcon', 'default');
        fdata.append('mquery', jfy([
            {'field': 'doc_tipo', 'value': 'FE'},
            {'field': 'ek_estado', 'value': 'Aprobado'},
            {'field': 'pdv_ruc', 'value': ruc},
            {'field': 'doc_relacion_saldo__gt', 'value': 0}
        ]));
        fdata.append('fields', jfy([
            'ek_cdc', 'id', 'doc_numero', 'doc_establecimiento', 'doc_expedicion', 'doc_moneda',
            'pdv_type_business', 'pdv_es_contribuyente', 'doc_relacion_saldo'
        ]));

        axios.post('{% url "iom" %}', fdata, {
            headers: { 'X-CSRFToken': OptsIO.getCookie('csrftoken') }
        }).then((rsp) => {
            let invoices = rsp.data.qs || [];

            if (invoices.length === 0) {
                facturaSelect.disabled = true;
                facturaSelect.innerHTML = '<option value="">No hay facturas disponibles</option>';
                msgFacturas.className = 'msg_facturas text-danger';
                msgFacturas.textContent = 'No se encontraron facturas para relacionar';
            } else {
                facturaSelect.disabled = false;
                facturaSelect.innerHTML = '<option value="">Seleccione una factura</option>';

                invoices.forEach(inv => {
                    let option = document.createElement('option');
                    option.value = inv.ek_cdc;
                    option.setAttribute('data-id', inv.id);
                    option.setAttribute('data-doc_numero', inv.doc_numero);
                    option.setAttribute('data-doc_establecimiento', inv.doc_establecimiento);
                    option.setAttribute('data-doc_expedicion', inv.doc_expedicion);
                    option.setAttribute('data-doc_moneda', inv.doc_moneda);
                    option.setAttribute('data-pdv_type_business', inv.pdv_type_business);
                    option.setAttribute('data-pdv_es_contribuyente', inv.pdv_es_contribuyente);
                    option.setAttribute('data-doc_relacion_saldo', inv.doc_relacion_saldo);

                    let estab = String(inv.doc_establecimiento).padStart(3, '0');
                    let exped = String(inv.doc_expedicion).padStart(3, '0');
                    let numero = String(inv.doc_numero).padStart(7, '0');
                    option.textContent = `${estab}-${exped}-${numero}`;

                    facturaSelect.appendChild(option);
                });

                msgFacturas.className = 'msg_facturas text-success';
                msgFacturas.textContent = `${invoices.length} factura(s) disponible(s)`;
            }
        }).catch((err) => {
            log.error('Error loading invoices: ' + JSON.stringify(err, null, 2));
            facturaSelect.disabled = true;
            facturaSelect.innerHTML = '<option value="">Error cargando facturas</option>';
            msgFacturas.className = 'msg_facturas text-danger';
            msgFacturas.textContent = 'Error al cargar facturas';
        });
    }

    // On Factura selection, populate fields but NOT details
    $('#form_documentnc_{{ rr }} select[name=doc_relacion_cdc]').on('change', function() {
        let selectedOption = $(this).find('option:selected');
        if (selectedOption.length > 0 && selectedOption.val()) {
            let factura_id = selectedOption.data('id');
            let doc_moneda = selectedOption.data('doc_moneda');
            let pdv_type_business = selectedOption.data('pdv_type_business');
            let pdv_es_contribuyente = selectedOption.data('pdv_es_contribuyente');
            let doc_relacion_saldo = selectedOption.data('doc_relacion_saldo');

            // Store available balance for validation
            facturaSaldoDisponible = parseFloat(doc_relacion_saldo) || 0;

            // Set currency to match invoice
            if (doc_moneda) {
                qelem('select[name=doc_moneda]').value = doc_moneda;
                $(qelem('select[name=doc_moneda]')).trigger('change');
            }

            // Set type of business
            if (pdv_type_business) {
                qelem('select[name=pdv_type_business]').value = pdv_type_business;
            }

            // Set es_contribuyente
            if (pdv_es_contribuyente !== undefined && pdv_es_contribuyente !== null) {
                qelem('input[name=pdv_es_contribuyente]').value = pdv_es_contribuyente;
            }

            // Clear details - user must enter them manually
            details = [];
            renderDetailsTable();
            enableDetailInputs();

            // Show available balance message
            let decimals = getDecimalPlaces();
            UiB.MsgInfo(`Saldo disponible de la factura: ${formatMoney(facturaSaldoDisponible, decimals)}`);
        } else {
            // Clear details if no factura selected
            facturaSaldoDisponible = 0;
            details = [];
            renderDetailsTable();
            enableDetailInputs();
        }
    });

    // Function to show detail inputs
    function enableDetailInputs() {
        detailsReadonly = false;
        // Show the detail input section
        $('.detail-input-section').removeClass('d-none');
    }

    // Populate Etimbrado select
    form_search.se_populate({
        surl: '{% url "iom" %}',
        dele: '#form_documentnc_{{ rr }} select[name=timbrado_id]',
        app_name: 'Sifen',
        model_name: 'Etimbrado',
        field_display: ['timbrado'],
        field_id: ['id'],
        db_fields: ['timbrado', 'id', 'ruc'],
        dbcon: 'default',
        theme: 'bootstrap-5',
        width: '100%',
        allowClear: false,
        placeholder: 'Seleccione timbrado',
        dropdownParent: $('#offcanvasGlobalUi'),
        endRow: 100,
        first_selected: true,
        headers: {
            'X-CSRFToken': OptsIO.getCookie('csrftoken')
        },
    }).then(() => {
        $('#form_documentnc_{{ rr }} select[name=timbrado_id]').trigger('change');
        initFloatingSelect2('#form_documentnc_{{ rr }} select[name=timbrado_id]');
    });

    // Floating label helper for Select2
    function initFloatingSelect2(selector) {
        let $select = $(selector);
        let $container = $select.closest('.form-floating-select2');

        // Set initial state
        if ($select.val()) {
            $container.addClass('has-value');
        }

        // On change
        $select.on('change', function() {
            $container.toggleClass('has-value', $(this).val() !== '' && $(this).val() !== null);
        });

        // On focus
        $select.on('select2:open', function() {
            $container.addClass('select2-focused');
        }).on('select2:close', function() {
            $container.removeClass('select2-focused');
        });
    }

    // Function to populate Establecimiento based on Timbrado
    function populateEstablecimiento(timbradoId) {
        form_search.se_populate({
            surl: '{% url "iom" %}',
            dele: '#form_documentnc_{{ rr }} select[name=doc_establecimiento]',
            app_name: 'Sifen',
            model_name: 'Eestablecimiento',
            field_display: ['establecimiento'],
            field_id: ['establecimiento'],
            db_fields: ['establecimiento', 'direccion'],
            qs_be: [
                { field: 'timbradoobj_id', value: timbradoId }
            ],
            dbcon: 'default',
            theme: 'bootstrap-5',
            width: '100%',
            allowClear: false,
            placeholder: 'Seleccione establecimiento',
            dropdownParent: $('#offcanvasGlobalUi'),
            endRow: 100,
            first_selected: true,
            headers: {
                'X-CSRFToken': OptsIO.getCookie('csrftoken')
            },
        }).then(() => {
            $('#form_documentnc_{{ rr }} select[name=doc_establecimiento]').trigger('change');
            initFloatingSelect2('#form_documentnc_{{ rr }} select[name=doc_establecimiento]');
        });
    }

    // On Timbrado change, populate Establecimiento
    $('#form_documentnc_{{ rr }} select[name=timbrado_id]').on('change', function() {
        let timbradoId = $(this).val();
        if (timbradoId) {
            populateEstablecimiento(timbradoId);
        }
    });

    // Function to fetch available numbers
    function fetchAvailableNumbers(timbrado, establecimiento) {
        let fdata = new FormData();
        fdata.append('module', 'Sifen');
        fdata.append('package', 'ekuatia_serials');
        fdata.append('attr', 'Eserial');
        fdata.append('mname', 'get_last_number');
        fdata.append('timbrado', timbrado);
        fdata.append('establecimiento', establecimiento);
        fdata.append('tipo', 'NC');

        axios.post('{% url "iom" %}', fdata, {
            headers: {
                'X-CSRFToken': OptsIO.getCookie('csrftoken')
            }
        }).then((rsp) => {
            let data = rsp.data;
            let docNumeroInput = qelem('#form_documentnc_{{ rr }} input[name=doc_numero]');
            if (data.numero) {
                docNumeroInput.value = data.numero;
                docNumeroInput.classList.remove('text-muted', 'text-danger');
                docNumeroInput.classList.add('text-success', 'fw-bold');
            } else if (data.error) {
                docNumeroInput.value = data.error;
                docNumeroInput.classList.remove('text-success', 'fw-bold');
                docNumeroInput.classList.add('text-danger');
            }
        }).catch((err) => {
            log.error('Error fetching last number: ' + JSON.stringify(err, null, 2));
            qelem('#form_documentnc_{{ rr }} input[name=doc_numero]').value = 'Error';
        });
    }

    // On Establecimiento change, fetch available numbers
    $('#form_documentnc_{{ rr }} select[name=doc_establecimiento]').on('change', function() {
        let timbrado = $('#form_documentnc_{{ rr }} select[name=timbrado_id] option:selected').text().trim();
        let establecimiento = $(this).val();
        if (timbrado && establecimiento) {
            fetchAvailableNumbers(timbrado, establecimiento);
        }
    });

    // Populate Unidad Medida select
    form_search.se_populate({
        surl: '{% url "iom" %}',
        dele: '#form_documentnc_{{ rr }} select[name=detail_prod_unidad_medida_desc]',
        app_name: 'Sifen',
        model_name: 'Medida',
        field_display: ['medida'],
        field_id: ['medida_cod'],
        db_fields: ['medida', 'medida_cod'],
        dbcon: 'default',
        theme: 'bootstrap-5',
        width: '100%',
        allowClear: true,
        placeholder: 'Seleccione unidad',
        dropdownParent: $('#offcanvasGlobalUi'),
        endRow: 10000,
        headers: {
            'X-CSRFToken': OptsIO.getCookie('csrftoken')
        },
    }).then(() => {
        $('#form_documentnc_{{ rr }} select[name=detail_prod_unidad_medida_desc]').val('77').trigger('change');
    });

    // Function to render details table
    function renderDetailsTable() {
        var thead = qelem('#form_documentnc_{{ rr }} .thead_details');
        var tbody = qelem('#form_documentnc_{{ rr }} .tbody_details');
        var tfoot = qelem('#form_documentnc_{{ rr }} .tfoot_details');
        tbody.innerHTML = '';
        var total = 0;
        var totalExenta = 0;
        var totalGravada5 = 0;
        var totalIva5 = 0;
        var totalGravada10 = 0;
        var totalIva10 = 0;
        var decimals = getDecimalPlaces();

        // Render table header
        thead.innerHTML = `
            <tr>
                <th>Unidad</th>
                <th>Descripción</th>
                <th>Precio Unit.</th>
                <th>Cantidad</th>
                <th>Exenta</th>
                <th>Gravada 5%</th>
                <th>IVA 5%</th>
                <th>Gravada 10%</th>
                <th>IVA 10%</th>
                <th>Subtotal</th>
                <th>Acciones</th>
            </tr>
        `;

        // Render table rows
        details.forEach((detail, index) => {
            var subtotal = parseFloat(detail.precio_unitario) * parseFloat(detail.cantidad);
            total += subtotal;
            totalExenta += parseFloat(detail.exenta || 0);
            totalGravada5 += parseFloat(detail.gravada_5 || 0);
            totalIva5 += parseFloat(detail.iva_5 || 0);
            totalGravada10 += parseFloat(detail.gravada_10 || 0);
            totalIva10 += parseFloat(detail.iva_10 || 0);

            var row = `
                <tr>
                    <td>${detail.prod_unidad_medida_desc_text || detail.prod_unidad_medida_desc}</td>
                    <td>${detail.prod_descripcion}</td>
                    <td class="text-end">${formatMoney(detail.precio_unitario, decimals)}</td>
                    <td class="text-end">${formatMoney(detail.cantidad, decimals)}</td>
                    <td class="text-end">${formatMoney(detail.exenta || 0, decimals)}</td>
                    <td class="text-end">${formatMoney(detail.gravada_5 || 0, decimals)}</td>
                    <td class="text-end">${formatMoney(detail.iva_5 || 0, decimals)}</td>
                    <td class="text-end">${formatMoney(detail.gravada_10 || 0, decimals)}</td>
                    <td class="text-end">${formatMoney(detail.iva_10 || 0, decimals)}</td>
                    <td class="text-end">${formatMoney(subtotal, decimals)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-warning" onclick="editDetail(${index})">
                            <i class="mdi mdi-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteDetail(${index})">
                            <i class="mdi mdi-delete"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        // Render table footer
        var footerRows = `
            <tr>
                <th colspan="4" class="text-end">Total:</th>
                <th class="text-end">${formatMoney(totalExenta, decimals)}</th>
                <th class="text-end">${formatMoney(totalGravada5, decimals)}</th>
                <th class="text-end">${formatMoney(totalIva5, decimals)}</th>
                <th class="text-end">${formatMoney(totalGravada10, decimals)}</th>
                <th class="text-end">${formatMoney(totalIva10, decimals)}</th>
                <th class="text-end">${formatMoney(total, decimals)}</th>
                <th></th>
            </tr>
        `;

        // Show balance validation if factura is selected

        var saldoRestante = facturaSaldoDisponible - total;
        var colorClass = saldoRestante >= 0 ? 'text-success' : 'text-danger';
        footerRows += `
            <tr>
                <th colspan="9" class="text-end">Saldo Disponible Factura:</th>
                <th class="text-end">${formatMoney(facturaSaldoDisponible, decimals)}</th>
                <th></th>
            </tr>
            <tr>
                <th colspan="9" class="text-end">Saldo Restante:</th>
                <th class="text-end ${colorClass}">${formatMoney(saldoRestante, decimals)}</th>
                <th></th>
            </tr>
        `;


        tfoot.innerHTML = footerRows;
    }

    // Function to add or update detail
    qelem('#form_documentnc_{{ rr }} .btn_agregar_linea').addEventListener('click', function() {
        let unidadCode = qelem('#form_documentnc_{{ rr }} select[name=detail_prod_unidad_medida_desc]').value.trim();
        let unidadText = $('#form_documentnc_{{ rr }} select[name=detail_prod_unidad_medida_desc] option:selected').text().trim() || 'UNI';
        let descripcionElem = $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]');
        let descripcion = descripcionElem.val();
        let descripcionText = descripcionElem.find('option:selected').text() || descripcion;
        let precio = qelem('#form_documentnc_{{ rr }} input[name=detail_precio_unitario]').value;
        let cantidad = qelem('#form_documentnc_{{ rr }} input[name=detail_cantidad]').value;

        if (!unidadCode || !descripcion || !precio || !cantidad) {
            UiB.MsgError('Por favor, complete todos los campos de la línea de detalle.');
            return;
        }

        let detail = {
            prod_unidad_medida_desc: unidadCode,
            prod_unidad_medida_desc_text: unidadText,
            prod_descripcion: descripcionText,
            precio_unitario: parseFloat(precio),
            cantidad: parseFloat(cantidad)
        };

        // Create product object for calculation
        let prodobj;

        // Determine if it's a product from model or manual entry
        if (selectedProductData) {
            // Product from database - use its tax distribution
            detail.prod_cod = selectedProductData.prod_cod;
            detail.is_from_model = true;

            // Determine porcentaje_iva based on distribution
            let porcentaje_iva = selectedProductData.g10 > 0 ? 10 : (selectedProductData.g5 > 0 ? 5 : 0);

            prodobj = {
                exenta: selectedProductData.exenta,
                g5: selectedProductData.g5,
                g10: selectedProductData.g10,
                porcentaje_iva__porcentaje: porcentaje_iva
            };

            log.info('Using product from model with distribution: exenta=' + prodobj.exenta + '%, g5=' + prodobj.g5 + '%, g10=' + prodobj.g10 + '%');
        } else {
            // Manual entry - use manual tax distribution
            let exenta = parseFloat(qelem('#form_documentnc_{{ rr }} input[name=detail_exenta]').value) || 0;
            let g5 = parseFloat(qelem('#form_documentnc_{{ rr }} input[name=detail_g5]').value) || 0;
            let g10 = parseFloat(qelem('#form_documentnc_{{ rr }} input[name=detail_g10]').value) || 0;

            // Validate: sum must be 100%
            let total = exenta + g5 + g10;
            if (Math.abs(total - 100) > 0.01) {
                UiB.MsgError(`La suma de porcentajes debe ser 100%. Actualmente es ${total.toFixed(2)}%`);
                return;
            }

            // Validate: cannot combine g5 and g10
            if (g5 > 0 && g10 > 0) {
                UiB.MsgError('No se puede combinar Gravada 5% con Gravada 10%. Solo una de ellas puede ser mayor a 0.');
                return;
            }

            detail.prod_cod = 1850;  // Special code for manual products
            detail.is_from_model = false;

            // Determine porcentaje_iva based on distribution
            let porcentaje_iva = g10 > 0 ? 10 : (g5 > 0 ? 5 : 0);

            prodobj = {
                exenta: exenta,
                g5: g5,
                g10: g10,
                porcentaje_iva__porcentaje: porcentaje_iva
            };

            log.info('Using manual product with distribution: exenta=' + prodobj.exenta + '%, g5=' + prodobj.g5 + '%, g10=' + prodobj.g10 + '%');
        }

        // Calculate tax amounts using ivn.calculate_price
        let pcalc = ivn.calculate_price(prodobj, parseFloat(precio), parseFloat(cantidad));

        // Store calculated values in detail
        detail.exenta = pcalc.exenta;
        detail.iva_5 = pcalc.iva_5;
        detail.gravada_5 = pcalc.gravada_5;
        detail.base_gravada_5 = pcalc.base_gravada_5;
        detail.iva_10 = pcalc.iva_10;
        detail.gravada_10 = pcalc.gravada_10;
        detail.base_gravada_10 = pcalc.base_gravada_10;

        // Store percentage distribution
        detail.exenta_pct = prodobj.exenta;
        detail.g5_pct = prodobj.g5;
        detail.g10_pct = prodobj.g10;

        if (editingIndex !== null) {
            // Update existing detail
            details[editingIndex] = detail;
            editingIndex = null;
            qelem('#form_documentnc_{{ rr }} .btn_agregar_linea').innerHTML = '<i class="mdi mdi-plus"></i>';
        } else {
            // Add new detail
            details.push(detail);
        }

        // Clear inputs
        $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]').val(null).trigger('change');
        selectedProductData = null;
        qelem('#form_documentnc_{{ rr }} input[name=detail_precio_unitario]').value = '';
        qelem('#form_documentnc_{{ rr }} input[name=detail_cantidad]').value = '';

        // Hide tax distribution fields after adding detail
        qelem('#form_documentnc_{{ rr }} .div_tax_distribution').style.display = 'none';

        // Reset tax distribution to defaults (but hidden)
        qelem('#form_documentnc_{{ rr }} input[name=detail_exenta]').value = '0';
        qelem('#form_documentnc_{{ rr }} input[name=detail_g5]').value = '0';
        qelem('#form_documentnc_{{ rr }} input[name=detail_g10]').value = '100';

        $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]').select2('open');
        renderDetailsTable();
    });

    // Function to edit detail
    window.editDetail = function(index) {
        let detail = details[index];
        qelem('#form_documentnc_{{ rr }} select[name=detail_prod_unidad_medida_desc]').value = detail.prod_unidad_medida_desc;

        // Set description in select2
        if (detail.prod_cod && detail.prod_cod !== 1850) {
            // Product from model
            let option = new Option(detail.prod_descripcion, detail.prod_cod, true, true);
            $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]').append(option).trigger('change');
            selectedProductData = {
                prod_cod: detail.prod_cod,
                precio: detail.precio_unitario,
                exenta: detail.exenta_pct || 0,
                g5: detail.g5_pct || 0,
                g10: detail.g10_pct || 0
            };
            qelem('#form_documentnc_{{ rr }} .div_tax_distribution').style.display = 'none';
        } else {
            // Manual product
            let option = new Option(detail.prod_descripcion, detail.prod_descripcion, true, true);
            $('#form_documentnc_{{ rr }} select[name=detail_prod_descripcion]').append(option).trigger('change');
            selectedProductData = null;
            qelem('#form_documentnc_{{ rr }} .div_tax_distribution').style.display = 'flex';
            qelem('#form_documentnc_{{ rr }} input[name=detail_exenta]').value = detail.exenta_pct || 0;
            qelem('#form_documentnc_{{ rr }} input[name=detail_g5]').value = detail.g5_pct || 0;
            qelem('#form_documentnc_{{ rr }} input[name=detail_g10]').value = detail.g10_pct || 100;
        }
        qelem('#form_documentnc_{{ rr }} input[name=detail_precio_unitario]').value = detail.precio_unitario;
        qelem('#form_documentnc_{{ rr }} input[name=detail_cantidad]').value = detail.cantidad;

        editingIndex = index;
        qelem('#form_documentnc_{{ rr }} .btn_agregar_linea').innerHTML = '<i class="mdi mdi-pencil"></i> Actualizar Línea';
    };

    // Function to delete detail
    window.deleteDetail = function(index) {
        UiB.MsgSwall({
            msg: '¿Estás seguro de que deseas eliminar esta línea?',
            ttype: 'warning'
        }).then((result) => {
            details.splice(index, 1);
            renderDetailsTable();
        });
    };

    // Save function
    save_documentnc = (target, btn_submitter_id) => {
        if (details.length === 0) {
            UiB.MsgError('Debe agregar al menos una línea de detalle.');
            return;
        }

        // Calculate total of NC
        let decimals = getDecimalPlaces();
        let totalNC = 0;
        details.forEach((detail) => {
            let subtotal = parseFloat(detail.precio_unitario) * parseFloat(detail.cantidad);
            totalNC += subtotal;
        });

        // Validate that NC total does not exceed available balance
        if (facturaSaldoDisponible > 0 && totalNC > facturaSaldoDisponible) {
            UiB.MsgError(`El total de la NC (${formatMoney(totalNC, decimals)}) supera el saldo disponible de la factura (${formatMoney(facturaSaldoDisponible, decimals)})`);
            return;
        }

        var fdata = new FormData();
        fdata.append('module', 'OptsIO');
        fdata.append('package', 'io_maction');
        fdata.append('attr', 'IOMaction');
        fdata.append('mname', 'process_record');
        fdata.append('model_app_name', 'Sifen');
        fdata.append('model_name', 'DocumentHeader');
        fdata.append('dbcon', 'default');

        log.info(`#form_documentnc_{{ rr }} Preparing data to be sent to the backend`);
        let formData = new FormData(target);
        let edata = form_serials.form_to_json(formData);
        edata['doc_moneda'] = qelem('select[name="doc_moneda"]').value;
        edata['pdv_type_business'] = qelem('select[name="pdv_type_business"]').value;
        edata['doc_tipo_pago_cod'] = qelem('select[name="doc_tipo_pago_cod"]').value;
        edata['doc_cre_tipo_cod'] = qelem('select[name="doc_cre_tipo_cod"]').value;
        
        // Remove temporary detail input fields
        delete edata['detail_prod_unidad_medida_desc'];
        delete edata['detail_prod_descripcion'];
        delete edata['detail_precio_unitario'];
        delete edata['detail_cantidad'];
        delete edata['detail_exenta'];
        delete edata['detail_g5'];
        delete edata['detail_g10'];

        // Add details to edata
        if (details.length === 0) {
            UiB.MsgError('Debe agregar al menos una línea de detalle.');
            return;
        }

        // Prepare details for backend - send percentage distribution
        let detailsForBackend = details.map(d => ({
            prod_cod: d.prod_cod,
            prod_descripcion: d.prod_descripcion,
            prod_unidad_medida_desc: d.prod_unidad_medida_desc,
            prod_unidad_medida_desc_text: d.prod_unidad_medida_desc_text,
            precio_unitario: d.precio_unitario,
            cantidad: d.cantidad,
            is_from_model: d.is_from_model,
            // Send percentages to backend
            exenta: d.exenta_pct,
            g5: d.g5_pct,
            g10: d.g10_pct
        }));

        edata['details'] = detailsForBackend;

        if (btn_submitter_id === 'btn_enviar') {
            edata['send_save'] = true;
        }

        log.info(`#form_documentnc_{{ rr }} edata to be sent: ` + JSON.stringify(edata, null, 2));
        fdata.append('uc_fields', jfy(edata));
        log.info(`#form_documentnc_{{ rr }} b_vals to be sent: ` + JSON.stringify([], null, 2));
        fdata.append('b_vals', jfy([]));
        log.info(`#form_documentnc_{{ rr }} c_a to be sent: ` + JSON.stringify([], null, 2));
        fdata.append('c_a', jfy([
            {
                'module': 'Sifen',
                'package': 'mng_sifen',
                'attr': 'MSifen',
                'mname': 'create_documentheader',
                'cont': false,
                'show_success': true
            },
        ]));
        log.info(`#form_documentnc_{{ rr }} a_vals to be sent: ` + JSON.stringify([], null, 2));
        fdata.append('a_vals', jfy([]));

        log.info(`#form_documentnc_{{ rr }} Set overlay to the form`);
        document.querySelector('#form_documentnc_{{ rr }}').classList.add('overlay-container');
        document.querySelector('#form_documentnc_{{ rr }}').classList.add('overlay');

        return axios.post(
            '{% url "iom" %}',
            fdata,
            { headers: {
                'X-CSRFToken': OptsIO.getCookie('csrftoken')
                }
            })
        .then((rsp)=>{
            msgs = rsp.data.msgs;
            log.info(`#form_documentnc_{{ rr }} Response msgs: ` + JSON.stringify(msgs, null, 2));
            if (!rsp.data.hasOwnProperty('msgs')) {
                msgs = [rsp.data];
            }
            got_error = false;
            msgs.forEach((ee)=>{
                if (ee.error) {
                    log.error(`#form_documentnc_{{ rr }} There is an error from the backend ${jfy(ee)}`);
                    got_error = true;
                }
            })
            log.info(`#form_documentnc_{{ rr }} Compiling messages to show to the user ${msgs}`);
            UiB.BeMsgHandle({
                rsps: msgs,
                timer: 2000,
                offcanvasglobal: true
            })
            return msgs;
        }).then((msgs)=>{
            if (got_error === false) {
                log.success(`#form_documentnc_{{ rr }} There is no error reload the datatable {{ t_guid }}`);
                $('#{{t_guid}}').DataTable().ajax.reload();
            }
        }).catch((err)=>{
            log.error(`#form_documentnc_{{ rr }} Error in save record: ` + JSON.stringify(err, null, 2));
            UiB.MsgError(err);
        }).finally(()=>{
            log.info(`#form_documentnc_{{ rr }} Removing overlay from the form`);
            let ft = document.querySelector('#form_documentnc_{{ rr }}');
            if (ft) {
                ft.classList.remove('overlay-container');
                ft.classList.remove('overlay');
            }
        });
    }

    qelem('#form_documentnc_{{ rr }}').addEventListener('submit', (evt)=>{
        evt.preventDefault();
        log.info(`#form_documentnc_{{ rr }} Submitting form`);
        btn_submitter_id = evt.submitter.attributes['id'].value;
        save_documentnc(event.target, btn_submitter_id);
    })

    // Load existing NC data if editing
    {% if mobj %}
        // Fetch existing details via AJAX
        var fetchDetails = new FormData();
        fetchDetails.append('module', 'Sifen');
        fetchDetails.append('package', 'mng_sifen');
        fetchDetails.append('attr', 'MSifen');
        fetchDetails.append('mname', 'get_documentdetails');
        fetchDetails.append('header_id', '{{ mobj.pk }}');
        fetchDetails.append('dbcon', 'default');

        axios.post('{% url "iom" %}', fetchDetails, {
            headers: { 'X-CSRFToken': OptsIO.getCookie('csrftoken') }
        }).then((rsp) => {
            if (rsp.data.success && rsp.data.details) {
                details = rsp.data.details;
                // Don't render yet - wait for factura balance to load first
            }
        }).catch((err) => {
            log.error('Error fetching details: ' + JSON.stringify(err, null, 2));
        }).then(()=>{
            {% if mobj.doc_loop_link %}
                getSelectedInvoice();
            {% else %}
                renderDetailsTable();
            {% endif %}
        });

        // Load related invoice if exists
        {% if mobj.doc_loop_link %}
            // Fetch related invoice data
            getSelectedInvoice = function () {
                var fetchRelated = new FormData();
                fetchRelated.append('module', 'OptsIO');
                fetchRelated.append('package', 'io_serial');
                fetchRelated.append('attr', 'IoS');
                fetchRelated.append('mname', 'seModel');
                fetchRelated.append('model_app_name', 'Sifen');
                fetchRelated.append('model_name', 'DocumentHeader');
                fetchRelated.append('dbcon', 'default');
                fetchRelated.append('mquery', jfy([
                    {'field': 'prof_number', 'value': '{{ mobj.doc_loop_link }}'}
                ]));
                fetchRelated.append('fields', jfy([
                    'ek_cdc', 'id', 'doc_numero', 'doc_establecimiento', 'doc_expedicion',
                    'doc_moneda', 'pdv_type_business', 'pdv_es_contribuyente', 'doc_relacion_saldo'
                ]));

                axios.post('{% url "iom" %}', fetchRelated, {
                    headers: { 'X-CSRFToken': OptsIO.getCookie('csrftoken') }
                }).then((rsp) => {
                    let invoices = rsp.data.qs || [];
                    if (invoices.length > 0) {
                        let inv = invoices[0];

                        // Enable and populate the select
                        let facturaSelect = qelem('#form_documentnc_{{ rr }} select[name=doc_relacion_cdc]');
                        facturaSelect.disabled = false;
                        facturaSelect.innerHTML = '';

                        let option = document.createElement('option');
                        option.value = inv.ek_cdc;
                        option.setAttribute('data-id', inv.id);
                        option.setAttribute('data-doc_numero', inv.doc_numero);
                        option.setAttribute('data-doc_establecimiento', inv.doc_establecimiento);
                        option.setAttribute('data-doc_expedicion', inv.doc_expedicion);
                        option.setAttribute('data-doc_moneda', inv.doc_moneda);
                        option.setAttribute('data-pdv_type_business', inv.pdv_type_business);
                        option.setAttribute('data-pdv_es_contribuyente', inv.pdv_es_contribuyente);
                        option.setAttribute('data-doc_relacion_saldo', inv.doc_relacion_saldo);

                        let estab = String(inv.doc_establecimiento).padStart(3, '0');
                        let exped = String(inv.doc_expedicion).padStart(3, '0');
                        let numero = String(inv.doc_numero).padStart(7, '0');
                        option.textContent = `${estab}-${exped}-${numero}`;
                        option.selected = true;

                        facturaSelect.appendChild(option);

                        // Store available balance (add back the current NC total to get original balance)
                        let currentNCTotal = {{ mobj.doc_total|default:0 }};
                        facturaSaldoDisponible = (parseFloat(inv.doc_relacion_saldo) || 0) + currentNCTotal;

                        // Now render the details table with the balance info
                        renderDetailsTable();
                    }
                }).catch((err) => {
                    log.error('Error loading related invoice: ' + JSON.stringify(err, null, 2));
                });
            }
        {% endif %}
    {% else %}
        setTimeout(() => {
            qelem('#form_documentnc_{{ rr }} input[name="pdv_ruc"]').focus();
        }, 500);
    {% endif %}
</script>
