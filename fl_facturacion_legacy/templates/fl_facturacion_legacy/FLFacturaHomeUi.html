<!--
    FLFacturaHomeUi.html - Administrar Facturas
    Equivalente a administrar_facturas.php del sistema Frontliner
-->
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="mdi mdi-file-document-multiple me-2"></i>Administrar Facturas</h5>
            <div>
                <button class="btn btn-light btn-sm" id="fl_btn_refresh">
                    <i class="mdi mdi-refresh"></i> Actualizar
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Leyenda de estados -->
            <div class="mb-3">
                <span class="badge bg-secondary me-2"><i class="mdi mdi-clock-outline"></i> Pendiente Pago</span>
                <span class="badge bg-warning text-dark me-2"><i class="mdi mdi-cash-clock"></i> Pago Confirmado</span>
                <span class="badge bg-success me-2"><i class="mdi mdi-check"></i> Facturado</span>
            </div>

            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label class="form-label">Nro. Acuse</label>
                    <input type="number" id="fl_filtro_acuse" class="form-control" placeholder="Buscar por acuse">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Cliente</label>
                    <select id="fl_filtro_cliente" class="form-select" style="width: 100%;">
                        <option value="">Todos los clientes</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Estado</label>
                    <select id="fl_filtro_estado" class="form-select">
                        <option value="">Todos</option>
                        <option value="2">Pendientes</option>
                        <option value="1">Facturados</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100" id="fl_btn_filtrar">
                        <i class="mdi mdi-filter"></i> Filtrar
                    </button>
                </div>
            </div>

            <!-- Tabla de Facturas -->
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="fl_tabla_facturas">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 60px;">Acuse</th>
                            <th style="width: 100px;">Fecha</th>
                            <th>Cliente</th>
                            <th>RUC</th>
                            <th class="text-end">Monto USD</th>
                            <th class="text-end">Monto Gs</th>
                            <th style="width: 100px;">Estado</th>
                            <th style="width: 150px;">Nro. Factura</th>
                            <th style="width: 120px;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="fl_tbody_facturas">
                        <tr>
                            <td colspan="9" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Paginación -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span id="fl_info_registros">Mostrando 0 registros</span>
                </div>
                <nav>
                    <ul class="pagination mb-0" id="fl_paginacion">
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Offcanvas Detalle Acuse -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="fl_offcanvas_detalle" style="width: 100vw !important; height: 100vh !important; max-width: none !important; left: 0 !important; right: 0 !important; top: 0 !important; bottom: 0 !important;">
    <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title">
            <i class="mdi mdi-file-document me-2"></i>
            Acuse #<span id="fl_detalle_acuse_id"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <!-- Info del Cliente y Factura -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong><i class="mdi mdi-account me-1"></i> Datos del Cliente</strong>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Cliente:</strong> <span id="fl_detalle_cliente"></span></p>
                        <p class="mb-2"><strong>RUC:</strong> <span id="fl_detalle_ruc"></span></p>
                        <p class="mb-0"><strong>Fecha:</strong> <span id="fl_detalle_fecha"></span></p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong><i class="mdi mdi-currency-usd me-1"></i> Montos</strong>
                    </div>
                    <div class="card-body">
                        <p class="mb-2"><strong>Monto USD:</strong> <span id="fl_detalle_monto_usd" class="text-primary fs-5"></span></p>
                        <p class="mb-2"><strong>Monto Gs:</strong> <span id="fl_detalle_monto_gs" class="text-success fs-5"></span></p>
                        <p class="mb-0"><strong>Estado:</strong> <span id="fl_detalle_estado"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Factura -->
        <div id="fl_detalle_factura_info" class="alert alert-success mb-4" style="display: none;">
            <i class="mdi mdi-check-circle me-2"></i>
            <strong>Nro. Factura:</strong> <span id="fl_detalle_nro_factura"></span>
        </div>

        <!-- Observación -->
        <div id="fl_detalle_obs_container" class="mb-4" style="display: none;">
            <strong>Observación:</strong> <span id="fl_detalle_observacion" class="text-muted"></span>
        </div>

        <!-- Tabla de Paquetes -->
        <div class="card">
            <div class="card-header bg-dark text-white">
                <strong><i class="mdi mdi-package-variant me-1"></i> Paquetes</strong>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0" style="table-layout: fixed;">
                        <thead class="table-secondary">
                            <tr>
                                <th style="width: 25%;">Tracking</th>
                                <th style="width: 45%;">Descripción</th>
                                <th class="text-end" style="width: 12%;">Peso (kg)</th>
                                <th class="text-end" style="width: 18%;">Monto Gs</th>
                            </tr>
                        </thead>
                        <tbody id="fl_detalle_paquetes">
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="2" class="text-end">TOTAL:</th>
                                <th class="text-end" id="fl_detalle_total_peso"></th>
                                <th class="text-end" id="fl_detalle_total_monto"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="mt-4 d-flex gap-2" id="fl_detalle_acciones">
            <button class="btn btn-success" id="fl_btn_ir_facturar" style="display: none;">
                <i class="mdi mdi-receipt me-1"></i> Ir a Facturar
            </button>
            <button class="btn btn-secondary" data-bs-dismiss="offcanvas">
                <i class="mdi mdi-close me-1"></i> Cerrar
            </button>
        </div>
    </div>
</div>

<script>
(function() {
    const MODULE = 'fl_facturacion_legacy';
    const PACKAGE = 'mng_fl';
    const ATTR = 'MFLFacturacion';

    let currentPage = 0;
    const pageSize = 50;
    let totalRegistros = 0;

    // Inicialización
    document.addEventListener('DOMContentLoaded', init);
    if (document.readyState !== 'loading') init();

    function init() {
        inicializarSelect2();
        setupEventListeners();
        cargarFacturas();
    }

    function inicializarSelect2() {
        $('#fl_filtro_cliente').select2({
            theme: 'bootstrap-5',
            placeholder: 'Buscar cliente...',
            allowClear: true,
            minimumInputLength: 3,
            ajax: {
                url: '/io/iom/',
                type: 'POST',
                dataType: 'json',
                delay: 400,
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('X-CSRFToken', OptsIO.getCookie('csrftoken'));
                },
                data: function(params) {
                    return {
                        module: MODULE,
                        package: PACKAGE,
                        attr: ATTR,
                        mname: 'buscar_clientes_select2',
                        q: params.term,
                        page: params.page || 1
                    };
                },
                processResults: function(data, params) {
                    params.page = params.page || 1;
                    return {
                        results: data.items || [],
                        pagination: {
                            more: (params.page * 30) < (data.total_count || 0)
                        }
                    };
                },
                cache: true
            },
            language: {
                inputTooShort: function() {
                    return 'Ingrese al menos 3 caracteres...';
                },
                searching: function() {
                    return 'Buscando...';
                },
                noResults: function() {
                    return 'No se encontraron clientes';
                }
            }
        });

        // Filtrar al seleccionar cliente
        $('#fl_filtro_cliente').on('select2:select select2:clear', function() {
            currentPage = 0;
            cargarFacturas();
        });
    }

    function setupEventListeners() {
        document.getElementById('fl_btn_refresh').addEventListener('click', () => {
            currentPage = 0;
            cargarFacturas();
        });

        document.getElementById('fl_btn_filtrar').addEventListener('click', () => {
            currentPage = 0;
            cargarFacturas();
        });

        // Enter en filtro de acuse
        document.getElementById('fl_filtro_acuse').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                currentPage = 0;
                cargarFacturas();
            }
        });

        document.getElementById('fl_filtro_estado').addEventListener('change', () => {
            currentPage = 0;
            cargarFacturas();
        });
    }

    async function cargarFacturas() {
        const tbody = document.getElementById('fl_tbody_facturas');
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </td>
            </tr>
        `;

        try {
            const fdata = new FormData();
            fdata.append('module', MODULE);
            fdata.append('package', PACKAGE);
            fdata.append('attr', ATTR);
            fdata.append('mname', 'get_todas_facturas');
            fdata.append('limit', pageSize);
            fdata.append('offset', currentPage * pageSize);

            // Filtros
            const acuseId = document.getElementById('fl_filtro_acuse').value;
            const clientecodigo = $('#fl_filtro_cliente').val();
            const estado = document.getElementById('fl_filtro_estado').value;

            if (acuseId) fdata.append('acuse_id', acuseId);
            if (clientecodigo) fdata.append('clientecodigo', clientecodigo);
            if (estado) fdata.append('facturaemitida', estado);

            const response = await axios.post('/io/iom/', fdata, {
                headers: {'X-CSRFToken': OptsIO.getCookie('csrftoken')}
            });

            if (response.data.error) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">${response.data.error}</td></tr>`;
                return;
            }

            totalRegistros = response.data.total;
            mostrarFacturas(response.data.facturas);
            actualizarPaginacion();

        } catch (error) {
            console.error('Error cargando facturas:', error);
            tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">Error al cargar facturas</td></tr>`;
        }
    }

    function mostrarFacturas(facturas) {
        const tbody = document.getElementById('fl_tbody_facturas');
        tbody.innerHTML = '';

        if (!facturas || facturas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">No se encontraron facturas</td></tr>';
            return;
        }

        facturas.forEach(f => {
            // Estado según PHP:
            // estado=1: Pendiente de pago
            // estado=2, facturaemitida=2: Pago confirmado, pendiente facturar
            // estado=2, facturaemitida=1: Facturado
            let estadoBadge, rowClass, acciones;

            if (f.estado === 1) {
                // Pendiente de pago (solo se generó ticket)
                estadoBadge = '<span class="badge bg-secondary"><i class="mdi mdi-clock-outline"></i> Pendiente</span>';
                rowClass = 'table-secondary';
                acciones = `
                    <button class="btn btn-sm btn-info fl-ver-detalle" data-acuse="${f.acuse_id}" title="Ver detalle">
                        <i class="mdi mdi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary fl-confirmar-pago" data-acuse="${f.acuse_id}" title="Confirmar Pago">
                        <i class="mdi mdi-cash"></i>
                    </button>
                `;
            } else if (!f.facturado) {
                // Pago confirmado pero no facturado
                estadoBadge = '<span class="badge bg-warning text-dark"><i class="mdi mdi-cash-clock"></i> Pago OK</span>';
                rowClass = 'table-warning';
                acciones = `
                    <button class="btn btn-sm btn-info fl-ver-detalle" data-acuse="${f.acuse_id}" title="Ver detalle">
                        <i class="mdi mdi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-success fl-facturar" data-acuse="${f.acuse_id}" title="Generar Factura SIFEN">
                        <i class="mdi mdi-receipt"></i>
                    </button>
                `;
            } else {
                // Facturado
                estadoBadge = '<span class="badge bg-success"><i class="mdi mdi-check"></i> SI</span>';
                rowClass = '';
                acciones = `
                    <button class="btn btn-sm btn-info fl-ver-detalle" data-acuse="${f.acuse_id}" title="Ver detalle">
                        <i class="mdi mdi-eye"></i>
                    </button>
                `;
                if (f.documentheader_id) {
                    acciones += `
                        <button class="btn btn-sm btn-danger fl-ver-pdf" data-dh-id="${f.documentheader_id}" title="Descargar PDF">
                            <i class="mdi mdi-file-pdf-box"></i>
                        </button>
                    `;
                }
            }

            const tr = document.createElement('tr');
            tr.className = rowClass;
            tr.innerHTML = `
                <td class="text-center fw-bold">${f.acuse_id}</td>
                <td>${f.fecha}</td>
                <td>${f.cliente_nombre}</td>
                <td>${f.cliente_ruc || '-'}</td>
                <td class="text-end">$ ${UiN.formatNumberU(f.monto_usd.toFixed(2))}</td>
                <td class="text-end">Gs. ${UiN.formatNumberU(f.monto_gs.toFixed(0))}</td>
                <td class="text-center">${estadoBadge}</td>
                <td>${f.id_factura || '-'}</td>
                <td class="text-center">${acciones}</td>
            `;
            tbody.appendChild(tr);
        });

        // Event listeners
        document.querySelectorAll('.fl-ver-detalle').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const acuseId = e.currentTarget.dataset.acuse;
                verDetalle(acuseId);
            });
        });

        document.querySelectorAll('.fl-confirmar-pago').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const acuseId = e.currentTarget.dataset.acuse;
                irAConfirmarPago(acuseId);
            });
        });

        document.querySelectorAll('.fl-facturar').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const acuseId = e.currentTarget.dataset.acuse;
                irAFacturar(acuseId);
            });
        });

        document.querySelectorAll('.fl-ver-pdf').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const dhId = e.currentTarget.dataset.dhId;
                descargarPdf(dhId);
            });
        });

        document.getElementById('fl_info_registros').textContent =
            `Mostrando ${facturas.length} de ${totalRegistros} registros`;
    }

    function irAConfirmarPago(acuseId) {
        // Navegar a la pantalla de facturar con el acuse preseleccionado (para confirmar pago)
        if (typeof window.launcherOpenApp === 'function') {
            window.launcherOpenApp({
                url: 'fl_facturacion_legacy/FLFacturarUi.html',
                friendly_name: 'Confirmar Pago',
                icon: 'mdi mdi-cash'
            });
            sessionStorage.setItem('fl_acuse_id_facturar', acuseId);
        } else {
            window.location.href = `/dtmpl/?template=fl_facturacion_legacy/FLFacturarUi.html&acuse_id=${acuseId}`;
        }
    }

    function actualizarPaginacion() {
        const paginacion = document.getElementById('fl_paginacion');
        paginacion.innerHTML = '';

        const totalPages = Math.ceil(totalRegistros / pageSize);
        if (totalPages <= 1) return;

        // Botón anterior
        const liPrev = document.createElement('li');
        liPrev.className = `page-item ${currentPage === 0 ? 'disabled' : ''}`;
        liPrev.innerHTML = `<a class="page-link" href="#">&laquo;</a>`;
        liPrev.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 0) {
                currentPage--;
                cargarFacturas();
            }
        });
        paginacion.appendChild(liPrev);

        // Páginas
        const startPage = Math.max(0, currentPage - 2);
        const endPage = Math.min(totalPages - 1, currentPage + 2);

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#">${i + 1}</a>`;
            li.addEventListener('click', (e) => {
                e.preventDefault();
                currentPage = i;
                cargarFacturas();
            });
            paginacion.appendChild(li);
        }

        // Botón siguiente
        const liNext = document.createElement('li');
        liNext.className = `page-item ${currentPage >= totalPages - 1 ? 'disabled' : ''}`;
        liNext.innerHTML = `<a class="page-link" href="#">&raquo;</a>`;
        liNext.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage < totalPages - 1) {
                currentPage++;
                cargarFacturas();
            }
        });
        paginacion.appendChild(liNext);
    }

    let offcanvasDetalle = null;
    let currentAcuseId = null;

    async function verDetalle(acuseId) {
        try {
            const fdata = new FormData();
            fdata.append('module', MODULE);
            fdata.append('package', PACKAGE);
            fdata.append('attr', ATTR);
            fdata.append('mname', 'get_factura_detalle');
            fdata.append('acuse_id', acuseId);

            const response = await axios.post('/io/iom/', fdata, {
                headers: {'X-CSRFToken': OptsIO.getCookie('csrftoken')}
            });

            if (response.data.error) {
                Swal.fire('Error', response.data.error, 'error');
                return;
            }

            const f = response.data.factura;
            const paquetes = response.data.paquetes || [];
            currentAcuseId = acuseId;

            // Llenar datos del offcanvas
            document.getElementById('fl_detalle_acuse_id').textContent = acuseId;
            document.getElementById('fl_detalle_cliente').textContent = f.cliente_nombre;
            document.getElementById('fl_detalle_ruc').textContent = f.cliente_ruc || '-';
            document.getElementById('fl_detalle_fecha').textContent = f.fecha;
            document.getElementById('fl_detalle_monto_usd').textContent = `$ ${UiN.formatNumberU(f.monto_usd.toFixed(2))}`;
            document.getElementById('fl_detalle_monto_gs').textContent = `Gs. ${UiN.formatNumberU(f.monto_gs.toFixed(0))}`;

            // Estado
            let estadoHtml;
            if (f.facturado) {
                estadoHtml = '<span class="badge bg-success"><i class="mdi mdi-check"></i> Facturado</span>';
            } else if (f.estado === 2) {
                estadoHtml = '<span class="badge bg-warning text-dark"><i class="mdi mdi-cash-clock"></i> Pago Confirmado</span>';
            } else {
                estadoHtml = '<span class="badge bg-secondary"><i class="mdi mdi-clock-outline"></i> Pendiente Pago</span>';
            }
            document.getElementById('fl_detalle_estado').innerHTML = estadoHtml;

            // Nro Factura
            const facturaInfo = document.getElementById('fl_detalle_factura_info');
            if (f.id_factura) {
                document.getElementById('fl_detalle_nro_factura').textContent = f.id_factura;
                facturaInfo.style.display = 'block';
            } else {
                facturaInfo.style.display = 'none';
            }

            // Observación
            const obsContainer = document.getElementById('fl_detalle_obs_container');
            if (f.observacion) {
                document.getElementById('fl_detalle_observacion').textContent = f.observacion;
                obsContainer.style.display = 'block';
            } else {
                obsContainer.style.display = 'none';
            }

            // Tabla de paquetes
            const tbody = document.getElementById('fl_detalle_paquetes');
            let totalPeso = 0;
            let totalMonto = 0;

            if (paquetes.length > 0) {
                tbody.innerHTML = paquetes.map(p => {
                    const peso = parseFloat(p.peso_real) || 0;
                    const monto = parseFloat(p.montogsdet) || 0;
                    totalPeso += peso;
                    totalMonto += monto;
                    return `
                        <tr>
                            <td style="word-break: break-all;"><code class="text-primary">${p.tracking || '-'}</code></td>
                            <td style="word-wrap: break-word;">${p.descripcion || '-'}</td>
                            <td class="text-end text-nowrap">${peso.toFixed(2)} kg</td>
                            <td class="text-end text-nowrap fw-bold">Gs. ${UiN.formatNumberU(monto.toFixed(0))}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Sin paquetes</td></tr>';
            }

            document.getElementById('fl_detalle_total_peso').innerHTML = `<span class="text-nowrap">${totalPeso.toFixed(2)} kg</span>`;
            document.getElementById('fl_detalle_total_monto').innerHTML = `<span class="text-nowrap fw-bold text-success">Gs. ${UiN.formatNumberU(totalMonto.toFixed(0))}</span>`;

            // Botón Ir a Facturar
            const btnFacturar = document.getElementById('fl_btn_ir_facturar');
            if (!f.facturado) {
                btnFacturar.style.display = 'inline-block';
                btnFacturar.onclick = () => {
                    offcanvasDetalle.hide();
                    irAFacturar(currentAcuseId);
                };
            } else {
                btnFacturar.style.display = 'none';
            }

            // Mostrar offcanvas
            if (!offcanvasDetalle) {
                offcanvasDetalle = new bootstrap.Offcanvas(document.getElementById('fl_offcanvas_detalle'));
            }
            offcanvasDetalle.show();

        } catch (error) {
            console.error('Error obteniendo detalle:', error);
            Swal.fire('Error', 'Error al obtener detalle de factura', 'error');
        }
    }

    async function descargarPdf(dhId) {
        const fdata = new FormData();
        fdata.append('module', 'Sifen');
        fdata.append('package', 'mng_sifen');
        fdata.append('attr', 'MSifen');
        fdata.append('mname', 'generando_documentheader');
        fdata.append('id', dhId);
        fdata.append('dbcon', 'default');

        const tt = qelem('#fl_tabla_facturas');
        tt.classList.add('overlay-container');
        tt.classList.add('overlay');

        try {
            const rsp = await axios.post('{% url "iom" %}', fdata, {
                headers: {'X-CSRFToken': OptsIO.getCookie('csrftoken')}
            });
            const data = rsp.data;
            if (data.success) {
                let link = document.createElement('a');
                link.href = data.ek_pdf_file;
                link.target = '_blank';
                link.click();
                UiB.MsgSuccess(data.success);
            } else if (data.error) {
                UiB.MsgError(data.error);
            }
        } catch (err) {
            console.error('Error al generar PDF:', err);
            UiB.MsgError('Ocurrió un error al generar el PDF.');
        } finally {
            tt.classList.remove('overlay-container');
            tt.classList.remove('overlay');
        }
    }

    function irAFacturar(acuseId) {
        // Navegar a la pantalla de facturar con el acuse preseleccionado
        const url = `/dtmpl/?template=fl_facturacion_legacy/FLFacturarUi.html&acuse_id=${acuseId}`;

        // Si estamos en SPA, usar la función de navegación
        if (typeof window.launcherOpenApp === 'function') {
            window.launcherOpenApp({
                url: 'fl_facturacion_legacy/FLFacturarUi.html',
                friendly_name: 'Facturar',
                icon: 'mdi mdi-receipt'
            });
            // Guardar el acuse_id para que lo lea la otra pantalla
            sessionStorage.setItem('fl_acuse_id_facturar', acuseId);
        } else {
            window.location.href = url;
        }
    }
})();
</script>
